service:
  name: serverless-appsync-relay

provider:
  name: aws
  runtime: nodejs14.x
  region: ap-southeast-1

plugins:
  - serverless-offline
  - serverless-appsync-simulator
  - serverless-appsync-plugin
  - serverless-webpack
functions:
  user-fn:
    handler: src/functions/user/index.handler
  device-fn:
    handler: src/functions/device/index.handler
  node-fn:
    handler: src/functions/node.handler
custom:
  appSync:
    name: ServelessAppSyncRelay
    schema: schema.graphql
    authenticationType: AMAZON_COGNITO_USER_POOLS
    userPoolConfig:
      awsRegion: # defaults to provider region
      defaultAction: # ALLOW
      userPoolId: # required # user pool ID
    mappingTemplatesLocation: src/mapping-templates
    mappingTemplates:
      ##Device Query Start##
      - dataSource: LambdaDeviceDatasource
        type: Query
        field: devices
        request: false
        response: false
      - dataSource: LambdaUserDatasource
        type: Query
        field: me
        request: false
        response: false
      - dataSource: LocalResolver
        type: DeviceEdge
        field: node
        request: Node.request.vtl
        response: Node.response.vtl
    dataSources:
      - type: AWS_LAMBDA
        name: LambdaDeviceDatasource
        config:
          functionName: device-fn
      - type: AWS_LAMBDA
        name: LambdaUserDatasource
        config:
          functionName: user-fn
      - type: AWS_LAMBDA
        name: LambdaNodeDatasource
        config:
          functionName: node-fn
      - type: NONE
        name: LocalResolver
